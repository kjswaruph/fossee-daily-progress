#!/bin/bash

testInput() {

	if [[ -z "${CLIENT_ID}" ]]; then
		echo "Error: CLIENT_ID is empty." >&2
		return 1
	fi

	if [[ -z "${CLIENT_SECRET}" ]]; then
		echo "Error: CLIENT_SECRET is empty." >&2
		return 1
	fi

	if [[ -z "${KEYCLOAK_BASE}" ]]; then
		echo "Error: KEYCLOAK_BASE is empty." >&2
		return 1
	fi

	if [[ -z "${KEYCLOAK_REALM}" ]]; then
		echo "Error: KEYCLOAK_REALM is empty." >&2
		return 1
	fi
}

userCreate() {
	/var/www/html/vendor/bin/drush user-create "${DRUPAL_USER}" --mail="testmail@gmail.com" --password="${DRUPAL_USER_PASSWORD}"
	/var/www/html/vendor/bin/drush user-add-role "administrator" "${DRUPAL_USER}"
	/var/www/html/vendor/bin/drush cr
}

moduleInstall() {
	chmod +x /var/www/html/vendor/bin/drush
	/var/www/html/vendor/bin/drush cr
	apt install unzip

	su -s /bin/bash "${USER}" -c "composer require drupal/openid_connect drupal/keycloak" || {
		echo "Failed to install modules with composer"
		return 1
	}

	echo "Enabling modules..."
	/var/www/html/vendor/bin/drush en keycloak -y || {
		echo "Failed to enable keycloak module"
		return 1
	}

	/var/www/html/vendor/bin/drush en openid_connect -y || {
		echo "Failed to enable openid_connect module"
		return 1
	}

	/var/www/html/vendor/bin/drush cr
}

createClient() {

	vendor/bin/drush config:set openid_connect.settings.keycloak enabled true -y || {
		echo "Failed to enable Keycloak"
		return 1
	}

	vendor/bin/drush config:set openid_connect.settings.keycloak settings.client_id "${CLIENT_ID}" -y || {
		echo "Failed to set client ID"
		return 1
	}

	vendor/bin/drush config:set openid_connect.settings.keycloak settings.client_secret "${CLIENT_SECRET}" -y || {
		echo "Failed to set client secret"
		return 1
	}

	vendor/bin/drush config:set openid_connect.settings.keycloak settings.keycloak_base "${KEYCLOAK_BASE}" -y || {
		echo "Failed to set Keycloak base URL"
		return 1
	}

	vendor/bin/drush config:set openid_connect.settings.keycloak settings.keycloak_realm "${KEYCLOAK_REALM}" -y || {
		echo "Failed to set Keycloak realm"
		return 1
	}

	vendor/bin/drush config:set openid_connect.settings.keycloak settings.userinfo_update_email false -y || {
		echo "Failed to set email update settings"
		return 1
	}

	vendor/bin/drush config:set openid_connect.settings.keycloak settings.keycloak_groups.enabled false -y || {
		echo "Failed to disable groups"
		return 1
	}
	vendor/bin/drush config:set openid_connect.settings.keycloak settings.keycloak_groups.claim_name groups -y || {
		echo "Failed to set group claim name"
		return 1
	}
	vendor/bin/drush config:set openid_connect.settings.keycloak settings.keycloak_groups.split_groups false -y || {
		echo "Failed to set split groups"
		return 1
	}
	vendor/bin/drush config:set openid_connect.settings.keycloak settings.keycloak_groups.split_groups_limit '0' -y || {
		echo "Failed to set split groups limit"
		return 1
	}
	vendor/bin/drush config:set openid_connect.settings.keycloak settings.keycloak_groups.rules [] -y || {
		echo "Failed to set group rules"
		return 1
	}

	vendor/bin/drush config:set openid_connect.settings.keycloak settings.keycloak_sso true -y || {
		echo "Failed to enable SSO"
		return 1
	}

	vendor/bin/drush config:set openid_connect.settings.keycloak settings.keycloak_sign_out true -y || {
		echo "Failed to enable sign out"
		return 1
	}

	vendor/bin/drush config:set openid_connect.settings.keycloak settings.check_session.enabled true -y || {
		echo "Failed to set session check"
		return 1
	}
	vendor/bin/drush config:set openid_connect.settings.keycloak settings.check_session.interval null -y || {
		echo "Failed to set session interval"
		return 1
	}

	vendor/bin/drush config:set openid_connect.settings.keycloak settings.redirect_url '' -y || {
		echo "Failed to set redirect URL"
		return 1
	}

	vendor/bin/drush config:set openid_connect.settings.keycloak settings.keycloak_i18n_enabled false -y || {
		echo "Failed to set i18n"
		return 1
	}

	vendor/bin/drush cr || {
		echo "Failed to clear cache"
		return 1
	}

	echo "Done! Configuration successful."
	return 0
}

DRUPAL_USER=""
DRUPAL_USER_PASSWORD=""
KEYCLOAK_BASE=""
KEYCLOAK_REALM=""
CLIENT_ID=""
CLIENT_SECRET=""
USER=""

main() {

	if [[ "$1" == "--client-id" ]]; then
		CLIENT_ID="$2"
		shift 2
	fi

	if [[ "$1" == "--client-secret" ]]; then
		CLIENT_SECRET="$2"
		shift 2
	fi

	if [[ "$1" == "--base" ]]; then
		KEYCLOAK_BASE="$2"
		shift 2
	fi

	if [[ "$1" == "--realm" ]]; then
		KEYCLOAK_REALM="$2"
		shift 2
	fi

	if [[ "$1" == "--drupal-user" ]]; then
		DRUPAL_USER="$2"
		shift 2
	fi

	if [[ "$1" == "--drupal-password" ]]; then
		DRUPAL_USER_PASSWORD="$2"
		shift 2
	fi

	if [[ "$1" == "--user" ]]; then
		USER="$2"
		shift 2
	fi

	{
		testInput &&
			moduleInstall &&
			userCreate &&
			createClient &&
			echo
		echo "::: Drupal OpenID Connect Setup Complete :::"
	} || {
		echo
		echo "!!! Drupal OpenID Connect Setup Failed !!!"
	}
}

main "$@"
